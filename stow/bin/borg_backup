#!/bin/bash

# Usage: borg_backup <host> <path> ...

set -eu

BACKUP_ROOT=~/Documents/Backups
REMOTE_HOST=$1
MOUNT_ROOT="$TMPDIR/borg/$REMOTE_HOST"
REMOTE_PATHS=""
for path in "${@:2}"; do
    REMOTE_PATHS="$REMOTE_PATHS ${MOUNT_ROOT}/${path}"
done
REPOSITORY=$BACKUP_ROOT/$REMOTE_HOST.borg
LOG=$BACKUP_ROOT/$REMOTE_HOST.log

exec > >(tee "$LOG") 2>&1

function cleanup {
    umount "$MOUNT_ROOT"
}
trap cleanup EXIT

mkdir -p "$MOUNT_ROOT"
sshfs -o idmap=user "$REMOTE_HOST:/" "$MOUNT_ROOT"
if [[ ! -e "$REPOSITORY" ]]; then
    borg init --verbose --encryption=none "$REPOSITORY"
fi

borg create --verbose --stats "$REPOSITORY::$(date +%Y.%m.%d.%H.%M)" $REMOTE_PATHS
borg prune --verbose "$REPOSITORY" --keep-daily=7 --keep-weekly=4 --keep-monthly=3
borg check --verbose "$REPOSITORY"
